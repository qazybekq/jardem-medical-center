# Git Sync Setup Guide

## Проблема

При деплое на Streamlit Cloud база данных SQLite хранится локально в контейнере. При перезапуске контейнер пересоздается из Git, и все данные теряются.

## Решение

Автоматическая синхронизация базы данных с Git репозиторием. При каждом изменении базы данных изменения автоматически коммитятся и пушатся в Git.

## Настройка для Streamlit Cloud

### 1. Настройка Git в Streamlit Cloud

1. Перейдите в настройки вашего приложения на Streamlit Cloud
2. Откройте раздел "Secrets"
3. Добавьте следующие секреты:

```toml
GIT_SYNC_ENABLED = "true"
GIT_USER_NAME = "Streamlit Cloud"
GIT_USER_EMAIL = "your-email@example.com"
GIT_BRANCH = "main"
GIT_REMOTE = "origin"
```

### 2. Настройка Git Credentials

Streamlit Cloud автоматически использует токен доступа из GitHub. Убедитесь, что:
- Репозиторий подключен к Streamlit Cloud
- У приложения есть права на запись в репозиторий

### 3. Обновление .gitignore

База данных `medical_center.db` должна быть закоммичена в Git. Убедитесь, что она НЕ в .gitignore:

```bash
# Удалите или закомментируйте строку:
# medical_center.db
```

### 4. Первоначальный коммит базы данных

Перед первым деплоем закоммитьте пустую базу данных:

```bash
git add medical_center.db
git commit -m "Initial database commit"
git push
```

## Как это работает

1. **При старте приложения:**
   - Система пытается получить последнюю версию базы данных из Git (`git pull`)
   - Если база данных существует локально, она обновляется

2. **При изменении данных:**
   - После каждого `conn.commit()` запускается асинхронная синхронизация
   - Изменения коммитятся в Git с сообщением "Auto-commit: [описание действия]"
   - Изменения автоматически пушатся в удаленный репозиторий

3. **Обработка ошибок:**
   - Если Git недоступен, система продолжает работать нормально
   - Ошибки синхронизации логируются, но не прерывают работу приложения

## Ограничения

1. **Конфликты при одновременных изменениях:**
   - Если несколько инстансов изменяют базу одновременно, возможны конфликты
   - Рекомендуется использовать один активный инстанс или настроить очередь изменений

2. **Размер базы данных:**
   - Git не очень хорошо работает с бинарными файлами
   - Если база данных становится очень большой (>50MB), рассмотрите использование облачной БД

3. **Производительность:**
   - Git операции выполняются асинхронно и не блокируют основную работу
   - При большом количестве изменений может быть небольшая задержка

## Альтернативные решения

Если Git синхронизация не подходит, рассмотрите:

1. **Облачная база данных:**
   - PostgreSQL на Heroku, AWS RDS, или Google Cloud SQL
   - Более надежное решение для production

2. **Облачное хранилище файлов:**
   - AWS S3, Google Cloud Storage
   - Автоматическое резервное копирование

3. **Streamlit Cloud Secrets для подключения к БД:**
   - Храните credentials в secrets
   - Подключайтесь к внешней БД

## Отключение Git синхронизации

Если нужно отключить синхронизацию:

1. В Streamlit Cloud Secrets установите:
```toml
GIT_SYNC_ENABLED = "false"
```

2. Или установите переменную окружения:
```bash
export GIT_SYNC_ENABLED=false
```

## Мониторинг

Проверьте логи Streamlit Cloud для сообщений о синхронизации:
- `✅ Git sync successful` - успешная синхронизация
- `⚠️ Git sync failed` - ошибка синхронизации (приложение продолжает работать)

## Troubleshooting

### База данных не синхронизируется

1. Проверьте, что `GIT_SYNC_ENABLED = "true"` в secrets
2. Убедитесь, что база данных не в .gitignore
3. Проверьте логи на наличие ошибок Git

### Конфликты при push

1. Git автоматически пытается разрешить конфликты
2. При серьезных конфликтах может потребоваться ручное разрешение
3. Рассмотрите использование отдельной ветки для базы данных

### Медленная синхронизация

1. Git операции выполняются асинхронно и не должны замедлять приложение
2. Если база данных очень большая, рассмотрите использование облачной БД

